<?xml version="1.0" encoding="ISO-8859-1" ?>
<project name="tagDiff" default="make" basedir="../.">

	<!-- Ajout d'un package pour utiliser le task IF -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

	<!--
	*********************************************************************
	Ce script permet de générer un report de diff entre 2 versions des sources.
	
	Avant de lancer le script fixer les paramètres d'environnement.

		set ANT_HOME=D:\Programs\ant\apache-ant-1.5.3-1
		set CVS_HOME=D:\programs\WinCvs
		set PATH=%ANT_HOME%\bin;%CVS_HOME%;


	Ce script attend en paramètre :

	OBLIGATOIRES
	************
		cvs.module : nom COMPLET du module CVS où se trouvent les éléments à comparer (et non pas alias)
		cvs.tag1 : 1ère version du module à prendre en compte.
		cvs.tag2 : 2ème version du module à prendre en compte.

	OPTIONNEL
	************
		fichierOut : nom du fichier produit. Par défaut, tagdiff.txt et tagdiff.xml
		dirOut : nom du répertoire de sortie. Par défaut, diffResult

	La chaîne de lancement est donc (par exemple) :

	ant -f tagDiff.xml -Dcvs.module=Developpement_dev/Hermes -Dcvs.tag1=LIV_4_0_11 -Dcvs.tag2=LAST -Dcvs.tag1=%1 -Dcvs.tag2=%2

	*********************************************************************
	-->

	<property name="root" value="${execDir}"/>
	<property name="temp.dir" value="${root}/tmp"/>
	
	<!--
	*********************************************************************
		Initialisations
	*********************************************************************
	-->
	<target name="init" depends="">

		<buildnumber file="${root}/build.number"/>
		<tstamp>
			<format property="TODAY_UK" pattern="d-MMMM-yyyy hh:mm:ss" locale="en"/>
		</tstamp>

		<!-- Le répertoire de log et le fichier log du script -->
		<property name="log.dir" value="${temp.dir}/log.${build.number}"/>
		<property name="log.file" value="${log.dir}/tagDiff.log"/>

		<!-- creation du répertoire et du fichier de log général -->
		<mkdir dir="${log.dir}"/>
		
		<!-- chargement d'un éventuel fichier properties avec les paramètres de lancement-->
		<if>
			<equals arg1="${property.file.dir}" arg2="$${property.file.dir}"/>
		<then>
			<property name="property.file.dir" value="scripts"/>
		</then>
		</if>
		<available file="${root}/${property.file.dir}/${property.file}" property="property.file.present" />
		<if>
			<equals arg1="${property.file.present}" arg2="true" />
			<then>
				<echo file="${log.file}" append="true">
					Utilisation du fichier ${property.file}
				</echo>
				<loadproperties srcFile="${root}/${property.file.dir}/${property.file}"/>
			</then>
			<else>
				<echo file="${log.file}" append="true">
						Pas de fichier de propriétés dans ${root}\${property.file.dir}
				</echo>
			</else>
		</if>

		<!-- Verification des paramètres obligatoires -->
		<if>
			<or>
				<equals arg1="${cvs.module}" arg2="$${cvs.module}" />
				<equals arg1="${cvs.tag1}" arg2="$${cvs.tag1}" />
				<equals arg1="${cvs.tag2}" arg2="$${cvs.tag2}" />
			</or>
			<then>
				<fail message="il manque un ou plusieurs paramètres obligatoires (cvs.module, cvs.tag1, cvs.tag2)"/>
			</then>
		</if>

		<!-- connexion à CVS -->
		<if>
			<equals arg1="${cvs.login}" arg2="$${cvs.login}" />
			<then>
				<property name="cvs.login" value="adminDEV"/>
			</then>
		</if>
		<if>
			<equals arg1="${cvs.server}" arg2="$${cvs.server}" />
			<then>
				<property name="cvs.server" value="hermescvs"/>
			</then>
		</if>
		<if>
			<equals arg1="${cvs.repo}" arg2="$${cvs.repo}" />
			<then>
				<property name="cvs.repo" value="/DEV"/>
			</then>
		</if>
		<property name="cvs.root" value=":pserver:${cvs.login}@${cvs.server}:${cvs.repo}"/>

		<if>
			<equals arg1="${fichierOut}" arg2="$${fichierOut}" />
			<then>
				<property name="fichierOut" value="tagdiff"/>
			</then>
		</if>
		<property name="fichierOut.txt" value="tagdiff_${fichierOut}.txt"/>
		<property name="fichierOut.html" value="tagdiff_${fichierOut}_${cvs.tag1}_${cvs.tag2}.html"/>

		<if>
			<equals arg1="${dirOut}" arg2="$${dirOut}" />
			<then>
				<property name="dirOut" value="diffResult"/>
			</then>
		</if>

		<echo file="${log.file}" append="true">
		*********************************************************************
			Lancement du script de création du report des différences
		*********************************************************************
		Connexion à CVS = ${cvs.root}

		Les sources CVS proviennent de : ${cvs.module}
		en version 1 :	${cvs.tag1}
		en version 2 :	${cvs.tag2}
		Fichiers de sorties :	${fichierOut.txt} et ${fichierOut.html}
		Répertoire de sortie : ${root}\${dirOut}
		</echo>

	</target>

	<!--
	*********************************************************************
	ETAPE 1 : Création du fichier XML des différences CVS.
						On créé également un fichier txt exploitable dans Excel
	*********************************************************************
	-->
	<target name="diffTagXML" depends="init">
		<echo file="${log.file}" append="true">
		*********************************************************************
			ETAPE 1 :	Création du fichier XML des différences CVS.
		*********************************************************************

		</echo>
		<cvstagdiff cvsRoot="${cvs.root}" package="${cvs.module}" destfile="${temp.dir}/tagdiff.xml" startTag="${cvs.tag1}" endTag="${cvs.tag2}"/>
		
		<echo file="${log.file}" append="true">
			Création du fichier txt exploitable dans Excel.
		</echo>
		<cvs cvsRoot="${cvs.root}" package="${cvs.module}" command="rdiff -s -r ${cvs.tag1} -r ${cvs.tag2}" output="${temp.dir}/${fichierOut.txt}" />
	</target>

	<!--
	*********************************************************************
	ETAPE 2 : Création du fichier HTML des différences.
	*********************************************************************
	-->
	<target name="diffTagHTML" depends="diffTagXML">
		<echo file="${log.file}" append="true">
		*********************************************************************
			ETAPE 2 :	Création du fichier HTML des différences.
		*********************************************************************

		</echo>
		<style in="${temp.dir}/tagdiff.xml" out="${root}/${dirOut}/${fichierOut.html}" style="${ant.home}/etc/tagdiff.xsl">
			<param name="title" expression="Différences sur le module ${cvs.module}"/>
			<param name="module" expression="${cvs.module}"/>
			<!--<param name="cvsweb" expression="http://cvs.apache.org/viewcvs/"/>-->
			<param name="cvsweb" expression="D:\\java\\projets\\"/>
		</style>
		<echo file="${log.file}" append="true">
			Création du fichier html.
		</echo>
	</target>

	<target name="make">
		<antcall target="diffTagHTML"/>
	</target>
</project>
