<?xml version="1.0" encoding="ISO-8859-1" ?>
<project name="zipCheckoutCVS" default="make" basedir=".">

	<!--
	*********************************************************************
		Ce script permet de zipper le contenu (ou sous ensemble) du répertoire checkout 
		dans lequel se trouve l'export du module source.
	*********************************************************************
	-->
	
	<!-- Ajout d'un package pour utiliser le task IF -->
	<taskdef resource="net/sf/antcontrib/antlib.xml" />
  
	<target name="init" depends="">
		<property name="livrable.properties" value="livrable.properties" />
		<available file="${livrable.properties}" property="livrable.properties.present" />
		<if>
			<equals arg1="${livrable.properties.present}" arg2="true" />
			<then>
				<echo message="ZipCkeckoutCVS - Utilisation du fichier ${basedir}/${livrable.properties}" />
				<loadproperties srcFile="${livrable.properties}" />
			</then>
			<else>
				<echo message="ZipCkeckoutCVS - Pas de fichier de propriétés ${livrable.properties} dans ${basedir}" />
			</else>
		</if>
		
		<property name="composants.properties" value="composants.properties" />
		<available file="${composants.properties}" property="composants.properties.present" />
		<if>
			<equals arg1="${composants.properties.present}" arg2="true" />
			<then>
				<echo message="ZipCkeckoutCVS - Utilisation du fichier ${basedir}/${composants.properties}" />
				<loadproperties srcFile="${composants.properties}" />
			</then>
			<else>
				<echo message="ZipCkeckoutCVS - Pas de fichier de propriétés ${composants.properties} dans ${basedir}" />
			</else>
		</if>

		<property name="traitement.properties" value="traitement.properties" />
		<available file="${traitement.properties}" property="traitement.properties.present" />
		<if>
			<equals arg1="${traitement.properties.present}" arg2="true" />
			<then>
				<echo message="ZipCkeckoutCVS - Utilisation du fichier ${basedir}/${traitement.properties}" />
				<loadproperties srcFile="${traitement.properties}" />
			</then>
			<else>
				<echo message="ZipCkeckoutCVS - Pas de fichier de propriétés ${traitement.properties} dans ${basedir}" />
			</else>
		</if>

		<!-- Verification des paramètres obligatoires -->
		<if>
			<or>
	  	 		<equals arg1="${sourceDir}" arg2="$${sourceDir}" />
				<equals arg1="${moduleCVSDir}" arg2="$${moduleCVSDir}" />
				<equals arg1="${nomLivrableFormate}" arg2="$${nomLivrableFormate}" />
				<equals arg1="${tagVersionCible}" arg2="$${tagVersionCible}" />
				<equals arg1="${refRegroupement}" arg2="$${refRegroupement}" />
				<equals arg1="${refTraitement}" arg2="$${refTraitement}" />
			</or>
			<then>
				<fail message="ZipCkeckoutCVS - il manque un ou plusieurs parametres obligatoires"/>
			</then>
		</if>

		<!--  Date heure -->
		<tstamp>
			<format property="DATE_FR" pattern="d-MMMM-yyyy hh:mm:ss" locale="fr"/>
		</tstamp>
		
		<!-- on recupère les fichiers dont le script à besoin -->
		<property environment="env"/>
		<copy file="${env.MODE_TRAITEMENT_HOME}/TraitementUnitaire/zip.xml" todir="${basedir}" />
		<copy file="${env.MODE_TRAITEMENT_HOME}/Assemblage/getSrcFromCVS.xml" todir="${basedir}" />

		<property name="temp.dir" value="${basedir}/tmp" />
		<property name="log.dir" value="${temp.dir}/log"/>
		<property name="log.file" value="${log.dir}/zipChekoutCVS.log"/>
		<mkdir dir="${log.dir}"/>

		<!-- les ressources particulières -->
		<property name="zip.name" value="${nomLivrableFormate}.zip"/>
	</target>

	<target name="make" depends="init">
		<!-- récupération des sources -->
		<ant antfile="getSrcFromCVS.xml" inheritall="true">
			<property name="checkoutDir" value="checkout"/>
		</ant>

		<!--  création du zip -->
		<ant antfile="zip.xml" inheritall="true" > 
			<property name="sourceFichiersDir" value="checkout/${moduleCVSDir}/${sourceDir}" />
			<property name="zip.name" value="${nomLivrableFormate}_intermediaire.zip" />
			<property name="zip.dir" value="${temp.dir}/zip"/>
		</ant>
		
		<!--  Ajout du fichier version.txt  -->
		<echo file="version.txt" append="true">
Name: ${codeApplication}
Version: ${tagVersionCible}.${refRegroupement}.${refTraitement}
Vendor: UEM - CGI
Built-Date: ${DATE_FR}
		</echo>
		<zip destfile="${nomLivrableFormate}.zip"> 
        	<zipfileset dir="." includes="version.txt" />
        	<zipfileset src="${basedir}/${nomLivrableFormate}_intermediaire.zip" />
        </zip>	
	</target>
</project>
