<?xml version="1.0" encoding="ISO-8859-1" ?>
<project name="getSrcFromCVS" default="make" basedir=".">

	<!-- Ajout d'un package pour utiliser le task IF -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

	<!-- *********************************************************************
	Ce script permet de récupérer des sources archivés sous CVS

	Ce script attend en paramètre :

 	OBLIGATOIRES
		moduleCVSDir : nom COMPLET du module à récupérer
		tagVersionCible : Tag de la version à récupérer
		CVS_HOST : nom du serveur CVS (composant)
		CVS_PORT : port pserver pour la connexion au serveur CVS (composant)
		CVS_REPO : nom du référentiel CVS CVS (composant)
		CVS_LOGIN : user de connexion au répo CVS (composant)
		CVS_PWD : pwd de la connexion au repo CVS (composant)

	*********************************************************************
	-->
	<target name="init">

		<!-- On Charge les fichiers properties utiles -->
		<property name="composants.properties" value="composants.properties" />
		<available file="${composants.properties}" property="composants.properties.present" />
		<if>
			<equals arg1="${composants.properties.present}" arg2="true" />
			<then>
				<echo message="getSrcFromCVS - Utilisation du fichier ${basedir}/${composants.properties}" />
				<loadproperties srcFile="${composants.properties}" />
			</then>
			<else>
				<echo message="getSrcFromCVS - Pas de fichier ${composants.properties} dans ${basedir}" />
			</else>
		</if>

		<!-- livrable.properties -->
		<property name="livrable.properties" value="livrable.properties" />
		<available file="${livrable.properties}" property="livrable.properties.present" />
		<if>
			<equals arg1="${livrable.properties.present}" arg2="true" />
			<then>
				<echo message="getSrcFromCVS - Utilisation du fichier ${basedir}/${livrable.properties}" />
				<loadproperties srcFile="${livrable.properties}" />
			</then>
			<else>
				<echo message="getSrcFromCVS - Pas de fichier ${livrable.properties}" />
			</else>
		</if>

		<!-- Verification des paramètres obligatoires -->
		<if>
			<or>
	  	 		<equals arg1="${moduleCVSDir}" arg2="$${moduleCVSDir}" />
	  	 		<equals arg1="${sourceDir}" arg2="$${sourceDir}" />
				<equals arg1="${tagVersionCible}" arg2="$${tagVersionCible}" />
				<equals arg1="${CVS_HOST}" arg2="$${CVS_HOST}" />
				<equals arg1="${CVS_PORT}" arg2="$${CVS_PORT}" />
				<equals arg1="${CVS_REPO}" arg2="$${CVS_REPO}" />
				<equals arg1="${CVS_LOGIN}" arg2="$${CVS_LOGIN}" />
				<equals arg1="${CVS_PWD}" arg2="$${CVS_PWD}" />
			</or>
			<then>
				<fail message="getSrcFromCVS - il manque un ou plusieurs parametres obligatoires"/>
			</then>
		</if>
		
		
		<property name="temp.dir" value="${basedir}/tmp"/>
		<property name="log.dir" value="${temp.dir}/log"/>
		<property name="log.file" value="${log.dir}/getSrcFromCVS.log"/>
		<mkdir dir="${log.dir}"/>
		
		<!-- propriétés calculées -->
		<property name="CVS_ROOT" value=":pserver:${CVS_LOGIN}:${CVS_PWD}@${CVS_HOST}:${CVS_PORT}:${CVS_REPO}"/>
		<property name="checkoutDir" value="../checkout" />

		<if>
			<equals arg1="${sourceDir}" arg2=""/>
		<then>
			<property name="cvs.module" value="${moduleCVSDir}"/>
		</then>
		<else>
			<property name="cvs.module" value="${moduleCVSDir}/${sourceDir}"/>
		</else>
		</if>

		<echo file="${log.file}" append="true">
*********************************************************************
	Lancement du script de récupération de code depuis CVS
*********************************************************************
La chaine de connexion a CVS est : ${CVS_ROOT}
Les sources CVS proviennent de : ${cvs.module}
en version (tag): ${tagVersionCible} 
		</echo>
	</target>
	
	<target name="make" depends="init">
		<if>
			<equals arg1="${tagVersionCible}" arg2="HEAD" />
		<then>
			<cvs cvsRoot="${CVS_ROOT}" package="${cvs.module}" quiet="yes" dest="${checkoutDir}"/>
		</then>
		<else>
			<cvs cvsRoot="${CVS_ROOT}" package="${cvs.module}" quiet="yes" dest="${checkoutDir}" tag="${tagVersionCible}" />
		</else>
		</if>
		<echo file="${log.file}" append="true">
Fin de la récupération OK
		</echo>
	</target>
</project>
