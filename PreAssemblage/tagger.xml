<?xml version="1.0" encoding="ISO-8859-1" ?>
<project name="tagger" default="make" basedir=".">


	<!-- Ajout d'un package pour utiliser le task IF -->
	<taskdef resource="net/sf/antcontrib/antlib.xml"/>

	<!--
	*********************************************************************
   	Ce sript permet de mettre un label ("tag") sur les sources d'un module dans CVS
	Avant de tagger une mise à jour de la copie locale est faite (par un nouveau checkout)

   Ce script attend en paramètre :

  	 OBLIGATOIRES
  	 tagVersionCible : nom du tag à mettre sur les sources
	 nomModuleCVS : nom complet du module CVS
	 
	*********************************************************************
	-->

	<!-- initialisation -->
	<target name="init" depends="">

		<!-- livrable.properties -->
		<property name="livrable.properties" value="livrable.properties" />
		<available file="${livrable.properties}" property="livrable.properties.present" />
		<if>
			<equals arg1="${livrable.properties.present}" arg2="true" />
		<then>
			<echo message="tagger - Utilisation du fichier ${livrable.properties}" />
			<loadproperties srcFile="${livrable.properties}" />
		</then>
		<else>
			<echo message="tagger - Pas de fichier de ${livrable.properties} propriétés dans ." />
		</else>
		</if>

		<!-- composants.properties -->
		<property name="composants.properties" value="composants.properties" />
		<available file="${composants.properties}" property="composants.properties.present" />
		<if>
			<equals arg1="${composants.properties.present}" arg2="true" />			
		<then>
			<echo message="tagger - Utilisation du fichier ${composants.properties}" />
			<loadproperties srcFile="${composants.properties}" />
		</then>
		<else>
			<echo message="tagger - Pas de fichier de ${composants.properties} propriétés dans ." />
		</else>
		</if>

		<!-- Verification des paramètres obligatoires -->
		<if>
			<or>
	  	 		<equals arg1="${moduleCVSDir}" arg2="$${moduleCVSDir}" />
	  	 		<equals arg1="${sourceDir}" arg2="$${sourceDir}" />
				<equals arg1="${tagVersionCible}" arg2="$${tagVersionCible}" />
			</or>
			<then>
				<fail message="tagger - il manque un ou plusieurs parametres obligatoires"/>
			</then>
		</if>

		<!-- Valuation des paramètres optionnels -->
		<if>
			<equals arg1="${cvs.date}" arg2="$${cvs.date}"/>
		<then>
			<property name="dateTag" value=""/>
		</then>
		<else>
			<property name="dateTag" value="${cvs.date}"/>
		</else>
		</if>

		<if>
			<or>
				<equals arg1="${cvs.branch}" arg2="$${cvs.branch}"/>
				<equals arg1="${cvs.branch}" arg2="HEAD"/>
			</or>
		<then>
			<property name="brancheATagger" value=""/>
		</then>
		<else>
			<property name="brancheATagger" value="${cvs.branch}"/>
		</else>
		</if>
		
		<!-- on recupère les fichiers dont le script à besoin -->
		<property environment="env"/>

		<property name="temp.dir" value="${basedir}/tmp" />
		<property name="log.dir" value="${temp.dir}/log"/>
		<property name="log.file" value="${log.dir}/tagger.log"/>

		<!-- creation du répertoire et du fichier de log général -->
		<mkdir dir="${log.dir}"/>

		<!-- propriétés calculées -->
		<property name="CVS_ROOT" value=":pserver:${CVS_LOGIN}:${CVS_PWD}@${CVS_HOST}:${CVS_PORT}:${CVS_REPO}"/>
		<property name="dirCheckout" value="${basedir}/checkout" />
		
		<if>
			<equals arg1="${sourceDir}" arg2=""/>
		<then>
			<property name="moduleATagger" value="${moduleCVSDir}"/>
		</then>
		<else>
			<property name="moduleATagger" value="${moduleCVSDir}/${sourceDir}"/>
		</else>
		</if>

		<echo file="${log.file}" append="true">
*********************************************************************
	Lancement du script de pose de tag sur les sources
*********************************************************************
Chaine de connexion à CVS : ${CVS_ROOT}
moduleATagger=${moduleATagger} 
brancheATagger=${brancheATagger}
dateTag=${dateTag}
Tag=${tagVersionCible}
		</echo>

	</target>


	<target name="getFromCVS" depends="init">
		<echo file="${log.file}" append="true">
********************************************************************
  ETAPE 1 :	Checkout de ${moduleATagger}
*********************************************************************
		</echo>
		<!-- checkout de la branche ou du head - si cette étape échoue le traitement doit être arrêté -->
		<cvs 	tag="${brancheATagger}" 
				date="${dateTag}" 
				cvsRoot="${CVS_ROOT}" 
				package="${moduleATagger}" 
				dest="${dirCheckout}" 
				command="checkout"
				failonerror="true"
				 />

		<echo file="${log.file}" append="true">
La version a été récupérée
		</echo>
	</target>


	<target name="tag" depends="getFromCVS">
		<echo file="${log.file}" append="true">
*********************************************************************
  ETAPE 2 : TAG
*********************************************************************
		</echo>
		<!-- pose du tag-->	
		<cvs dest="${dirCheckout}/${moduleATagger}" command="tag ${tagVersionCible}" failonerror="true"/>

		<echo file="${log.file}" append="true">
Pose du tag (${tagVersionCible}) OK sur ${moduleATagger}
		</echo>
	</target>

	<target name="make">
		<antcall target="tag"/>
	</target>
</project>
